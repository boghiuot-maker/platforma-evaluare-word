<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8">
  <title>Panou profesor</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <style>table{border-collapse:collapse;width:100%}th,td{border:1px solid #ddd;padding:6px}</style>
</head>
<body>
  <div class="container">
    <header><h1>Panou profesor</h1></header>
    <main>
<div class="filter-bar" style="margin-bottom:15px; display:flex; gap:12px; align-items:center;">
  <label>Clasa:
    <select id="filterClass">
      <option value="">Toate</option>
      <option>A</option><option>B</option><option>C</option>
      <option>D</option><option>E</option><option>F</option>
    </select>
  </label>

  <label>Data testului:
    <input type="date" id="filterDate">
  </label>

  <button class="btn" id="resetFilters">Reset filtre</button>
</div>
<p><a class="btn" id="exportFilteredXlsx">Export XLSX (filtrat)</a> <a class="btn" id="exportFilteredPdf">Export PDF (filtrat)</a></p>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const cls = document.getElementById("filterClass");
  const date = document.getElementById("filterDate");
  const reset = document.getElementById("resetFilters");
  const rows = document.querySelectorAll("table.results tbody tr");

  function applyFilters() {
    let c = cls.value;
    let d = date.value;

    rows.forEach(row => {
      let rClass = row.children[3].innerText.trim();
      let rDate  = row.children[4].innerText.trim();

      let okClass = (!c || rClass === c);
      let okDate  = (!d || rDate === d);

      row.style.display = (okClass && okDate) ? "" : "none";
    });
  }

  cls.addEventListener("change", applyFilters);
  date.addEventListener("change", applyFilters);
  reset.addEventListener("click", function() {
    cls.value = "";
    date.value = "";
    rows.forEach(r => r.style.display = "");
  });
});
</script>

      <p><a class="btn" href="/admin/export/xlsx?pw=profesor">Descarcă XLSX</a> &nbsp; <form method="post" action="/admin/delete_all?pw=profesor" style="display:inline" onsubmit="return confirm('Sigur vrei să ștergi toate rezultatele și fișierele încărcate?');"><button class="btn" type="submit">Șterge toate rezultatele</button></form></p>
      <table class="results">
        <thead><tr><th>#</th><th>Timestamp</th><th>Nume</th><th>Clasa</th><th>Data</th><th>Fisier</th><th>Scor</th><th>Lucrare</th><th>PDF</th></tr></thead>
        <tbody>
        {% for r in records %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ r.timestamp }}</td>
            <td>{{ r.nume_elev }}</td>
            <td>{{ r.clasa }}</td>
            <td>{{ r.data_test }}</td>
            <td>{{ r.fisier }}</td>
            <td>{{ r.scor }} / {{ r.punctaj_maxim }}</td>
            
            <td><a class="btn" href="/uploads/{{ r.fisier }}?pw=profesor">Lucrare</a></td><td><a class="btn" href="/admin/result/{{ r.fisier }}/pdf?pw=profesor">PDF</a></td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </main>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // sorting
  const getCell = (row, idx) => row.children[idx].innerText.trim();
  const table = document.querySelector("table.results");
  const tbody = table.querySelector("tbody");
  const headers = table.querySelectorAll("th");
  let sortDir = {};
  headers.forEach((h, idx) => {
    h.style.cursor = 'pointer';
    h.addEventListener('click', function() {
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const dir = sortDir[idx] === 'asc' ? 'desc' : 'asc';
      sortDir[idx] = dir;
      rows.sort((a,b) => {
        const va = getCell(a, idx);
        const vb = getCell(b, idx);
        if (!isNaN(parseFloat(va)) && !isNaN(parseFloat(vb))) {
          return dir === 'asc' ? parseFloat(va) - parseFloat(vb) : parseFloat(vb) - parseFloat(va);
        }
        return dir === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
      });
      rows.forEach(r => tbody.appendChild(r));
      applyColoring(); // recolor after sort
    });
  });

  // apply coloring based on percentage
  function applyColoring() {
    const rows = tbody.querySelectorAll('tr');
    rows.forEach(row => {
      try {
        const scorText = row.children[6].innerText.split('/')[0].trim();
        const maxText = row.children[6].innerText.split('/')[1].trim();
        const scor = parseFloat(scorText) || 0;
        const max = parseFloat(maxText) || 1;
        const pct = (scor / max) * 100;
        if (pct < 50) {
          row.style.background = '#ffe5e5'; // soft red
        } else if (pct < 80) {
          row.style.background = '#fff4cc'; // soft yellow
        } else {
          row.style.background = '#e6ffe6'; // soft green
        }
      } catch(e) {
        row.style.background = '';
      }
    });
  }

  // wire export filtered buttons
  const exportXlsxBtn = document.getElementById('exportFilteredXlsx');
  const exportPdfBtn = document.getElementById('exportFilteredPdf');
  const cls = document.getElementById("filterClass");
  const date = document.getElementById("filterDate");

  function currentFilters() {
    return { clasa: cls ? cls.value : '', data_test: date ? date.value : '' };
  }

  exportXlsxBtn && exportXlsxBtn.addEventListener('click', function() {
    const f = currentFilters();
    const url = `/admin/export/filtered/xlsx?pw=profesor&clasa=${encodeURIComponent(f.clasa)}&data_test=${encodeURIComponent(f.data_test)}`;
    window.location = url;
  });
  exportPdfBtn && exportPdfBtn.addEventListener('click', function() {
    const f = currentFilters();
    const url = `/admin/export/filtered/pdf?pw=profesor&clasa=${encodeURIComponent(f.clasa)}&data_test=${encodeURIComponent(f.data_test)}`;
    window.location = url;
  });

  // ensure filters existing code selects rows; correct applyFilters implementation
  const filterClass = document.getElementById("filterClass");
  const filterDate = document.getElementById("filterDate");
  const reset = document.getElementById("resetFilters");
  const rowsNodeList = document.querySelectorAll("table.results tbody tr");

  function applyFilters() {
    const c = filterClass ? filterClass.value : '';
    const d = filterDate ? filterDate.value : '';
    rowsNodeList.forEach(row => {
      const rClass = row.children[3].innerText.trim();
      const rDate = row.children[4].innerText.trim();
      const okClass = (!c || rClass === c);
      const okDate = (!d || rDate === d);
      row.style.display = (okClass && okDate) ? '' : 'none';
    });
    applyColoring();
  }

  if (filterClass) filterClass.addEventListener('change', applyFilters);
  if (filterDate) filterDate.addEventListener('change', applyFilters);
  if (reset) reset.addEventListener('click', function() {
    if (filterClass) filterClass.value = '';
    if (filterDate) filterDate.value = '';
    rowsNodeList.forEach(r => r.style.display = '');
    applyColoring();
  });

  // initial coloring
  applyColoring();
});
</script>

</body>
</html>
